name: Promote Release Branch

on:
  workflow_dispatch:
    inputs:
      action:
        description: "promote (test -> vX) or archive (vX -> tag, start vY)"
        required: true
        default: promote
        type: choice
        options: [promote, archive]
      target_branch:
        description: "Release branch name (e.g., v1, v2)"
        required: true
        type: string
      next_branch:
        description: "Next release branch when archiving (e.g., v2)"
        required: false
        type: string
      tag_name:
        description: "Tag to create/update when promoting (e.g., v1.0.0)"
        required: false
        type: string
      archive_tag:
        description: "Tag to write when archiving (defaults to <target_branch>-archive)"
        required: false
        type: string

jobs:
  promote:
    if: ${{ github.event.inputs.action == 'promote' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Promote test to target branch
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          set -euo pipefail
          git fetch origin
          git show-ref --verify --quiet refs/remotes/origin/test

          # Reset/create the target release branch to the current test tip.
          git checkout origin/test
          git checkout -B "$TARGET_BRANCH"
          git push origin "$TARGET_BRANCH"

          # Optional tag for the promotion.
          if [ -n "$TAG_NAME" ]; then
            git tag -f "$TAG_NAME" HEAD
            git push origin "$TAG_NAME" --force
          fi

  archive:
    if: ${{ github.event.inputs.action == 'archive' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Archive target branch and start next
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          NEXT_BRANCH: ${{ github.event.inputs.next_branch }}
          ARCHIVE_TAG: ${{ github.event.inputs.archive_tag }}
        run: |
          set -euo pipefail
          git fetch origin
          git show-ref --verify --quiet "refs/remotes/origin/$TARGET_BRANCH"

          # Tag the archived release tip.
          TAG_NAME=${ARCHIVE_TAG:-${TARGET_BRANCH}-archive}
          git tag -f "$TAG_NAME" "origin/$TARGET_BRANCH"
          git push origin "$TAG_NAME" --force

          # Optionally start the next release branch from test.
          if [ -n "${NEXT_BRANCH:-}" ]; then
            git show-ref --verify --quiet refs/remotes/origin/test
            git checkout origin/test
            git checkout -B "$NEXT_BRANCH"
            git push origin "$NEXT_BRANCH"
          fi

name: Promote Release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "promote (test -> main) or archive (tag current main)"
        required: true
        default: promote
        type: choice
        options: [promote, archive]
      tag_name:
        description: "Tag to create when promoting (e.g., v0.3.0)"
        required: false
        type: string
      archive_tag:
        description: "Tag name when archiving (e.g., v1-archive)"
        required: false
        type: string

jobs:
  promote:
    if: ${{ github.event.inputs.action == 'promote' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run tests
        run: go test -v ./...

      - name: Promote test to main
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          set -euo pipefail
          git fetch origin
          git show-ref --verify --quiet refs/remotes/origin/test

          # Reset main to the current test tip
          git checkout origin/test
          git checkout -B main
          git push origin main --force

          # Create version tag if specified
          if [ -n "$TAG_NAME" ]; then
            git tag -f "$TAG_NAME" HEAD
            git push origin "$TAG_NAME" --force
          fi

  archive:
    if: ${{ github.event.inputs.action == 'archive' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Archive current main
        env:
          ARCHIVE_TAG: ${{ github.event.inputs.archive_tag }}
        run: |
          set -euo pipefail
          git fetch origin

          # Tag the current main for archive
          if [ -z "${ARCHIVE_TAG:-}" ]; then
            echo "Error: archive_tag is required"
            exit 1
          fi

          git tag -f "$ARCHIVE_TAG" origin/main
          git push origin "$ARCHIVE_TAG" --force

name: Promote Release

on:
  workflow_dispatch:
    inputs:
      action:
        description: "promote (test -> main) or archive (tag current main)"
        required: true
        default: promote
        type: choice
        options: [promote, archive]
      tag_name:
        description: "Tag to create when promoting (e.g., v0.3.0)"
        required: false
        type: string
      archive_tag:
        description: "Tag name when archiving (e.g., v1-archive)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    if: ${{ github.event.inputs.action == 'promote' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'

      - name: Run tests
        run: go test -v ./...

      - name: Create promotion PR
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head test --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for test -> main"
            echo "URL: https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
          else
            # Create PR to merge test into main
            PR_TITLE="Release: Promote test to main"
            if [ -n "${TAG_NAME:-}" ]; then
              PR_TITLE="Release ${TAG_NAME}: Promote test to main"
            fi

            PR_URL=$(gh pr create \
              --base main \
              --head test \
              --title "$PR_TITLE" \
              --body "## Summary

          Automated promotion of test branch to main.

          $(if [ -n "${TAG_NAME:-}" ]; then echo "**Version tag:** ${TAG_NAME}"; fi)

          ## Test plan

          - [x] All tests pass on test branch
          - [ ] Review changes before merging

          ðŸ¤– Generated with GitHub Actions")

            echo "Created PR: $PR_URL"
          fi

  archive:
    if: ${{ github.event.inputs.action == 'archive' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Archive current main
        env:
          ARCHIVE_TAG: ${{ github.event.inputs.archive_tag }}
        run: |
          set -euo pipefail
          git fetch origin

          # Tag the current main for archive
          if [ -z "${ARCHIVE_TAG:-}" ]; then
            echo "Error: archive_tag is required"
            exit 1
          fi

          git tag -f "$ARCHIVE_TAG" origin/main
          git push origin "$ARCHIVE_TAG" --force
